---
### main.yml - common role for an OpenShift Origin deployment 
#
# Ansible playbook to deploy OpenShift Origin using nightly builds
#

- name: Add RHN channels
  ## rhn_channel: name={{ item }} sysname={{ inventory_hostname }} url=https://rhn.redhat.com/rpc/api user={{ rhn_user }} password={{ rhn_password }}
  shell: creates=/var/cache/yum/x86_64/6Server/{{ item }} subscription-manager repos --enable={{ item }}
  when: ansible_distribution == "RedHat" and ansible_distribution_major_version|int >= 6 and rhn_add_channels
  tags: install
  with_items:
  - rhel-6-server-supplementary-rpms
  - rhel-6-server-rh-common-rpms
  - rhel-server-rhscl-6-rpms
  - rhel-6-server-rhn-tools-rpms
  - rhel-6-server-rpms
  - rhel-server-rhscl-6-eus-rpms
  - rhel-6-server-extras-rpms
  - rhel-6-server-optional-rpms

# Setup repos
## apparently copy operations will fail without python-libselinux....
- name: Install common packages
  tags: install
  yum : name={{ item }} state=installed
  with_items:
   # Sounds like priorities mess up dependencies
   # - yum-plugin-priorities
   - yum-plugin-protectbase
   - libselinux-python
   - policycoreutils
   - policycoreutils-python
   - ntp
 
- name: Setup Extra repos
  tags: install
  copy: src={{ item }} dest=/etc/yum.repos.d/{{ item }} backup=no 
  with_items:
      # - rhel-openshift-origin-deps.repo
      # - rhel-openshift-origin.repo
      - rhel-epel.repo
  when: ansible_distribution == "RedHat"

- name: Bootstrap EPEL
  yum: name=epel-release state=present enablerepo=epel-oso disable_gpg_check=yes

- name: setup EPEL priority
  ini_file: dest=/etc/yum.repos.d/epel.repo section=epel option=priority value={{ epel_repo_priority }} backup=no

- name: add excludes to EPEL definition
  # had to add armadillo as it was breaking things
  ini_file: dest=/etc/yum.repos.d/epel.repo section=epel option=exclude value='*passenger* nodejs* mcollective* armadillo*' backup=no
  

- name: Setup OpenShift Origin Nightly Repo
  template: src=openshift-origin-nightly.repo.j2
            dest=/etc/yum.repos.d/openshift-origin-nightly.repo
  when: oo_nightly == "true"
- name: Setup OpenShift Origin Nightly Supplemental Repo
  template: src=openshift-origin-nightly-deps.repo.j2
            dest=/etc/yum.repos.d/openshift-origin-nightly-deps.repo
  when: oo_nightly == "true"

- name: Setup OpenShift Origin Stable
  template: src=openshift-origin-stable.repo.j2
            dest=/etc/yum.repos.d/openshift-origin-stable-{{ oo_stable_ver }}.repo
  when: oo_stable == "true"
- name: Setup OpenShift Origin Nightly Supplemental Repo
  template: src=openshift-origin-stable-deps.repo.j2
            dest=/etc/yum.repos.d/openshift-origin-stable-{{ oo_stable_ver }}-deps.repo
  when: oo_stable == "true"

- name: Force distro sync
  shell: yum -y distribution-synchronization

- name: Ensure Installed - policycoreutils
  yum: pkg=policycoreutils state={{ install_mode }}

- name: Ensure Installed - policycoreutils-python
  yum: pkg=policycoreutils-python state={{ install_mode }}

# Default firewalld configs
- name: Ensure Install - firewall
  yum: pkg=system-config-firewall-base state={{ install_mode }}

# Ensure NTP installed and configured
- name: Ensure Install - ntpdate
  tags: install
  yum: pkg={{ item }} state={{ install_mode }}
  with_items:
  - ntp
  - ntpdate

## Should this be thrown into node/broker??
- name: Install Ruby on RHEL
  tags: install
  yum: name=ruby193 state=present
  when: ansible_distribution == "RedHat"

